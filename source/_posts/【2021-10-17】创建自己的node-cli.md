---
title: 创建自己的node cli
date: 2021-10-17 22:18:15
tags:
	- node cli
---

经常使用`create-react-app`作为命令行生成项目，总想着自己能配置一个属于自己的命令行工具，很酷炫的样子。最近有时间，终于来实现了

<!-- more -->

## 初始化项目
```bash
mkdir y-cli && cd y-cli
npm init -y
```

## 核心步骤 `npm link`

新建一个文件 `./bin/ych.js`，并写一点简单的东西  
```js
// 这里告诉系统要以node环境执行：
#!/usr/bin/env node

console.log('hello,node cli!')
```

再在 `package.json` 里添加 `bin` 配置，需要指定一个自定义命令，如 `y-cli`
```json
  "bin": {
    "y-cli": "./bin/ych.js"
  }
```

在命令行里运行：

```bash
npm link
# 或者在全局install：
npm install . -g
```

可以看到如下，npm将命令作为软链接连接至对应的js文件
```bash
xxx@xxxMBP y-cli % sudo npm link
npm WARN y-cli@1.0.0 No description
npm WARN y-cli@1.0.0 No repository field.

up to date in 0.832s
found 0 vulnerabilities

/usr/local/bin/ych -> /usr/local/lib/node_modules/y-cli/bin/ych.js
/usr/local/lib/node_modules/y-cli -> /Users/xxx/Documents/code/y-cli
```

## 所用到的库
cli需要获取用户的输入，选择并做相应的事情，就需要使用到一些库来帮忙我们更方便的写cli

核心：
- commander - 处理核心命令 主要模块，在终端输出各种信息全靠这个模块
- download-git-repo - 下载git模块

美化：
- chalk  —  美化终端字符显示
- figlet  —  在终端输出大型字符
- inquirer  —  命令行参数输入交互
- shelljs  —  在js文件写命令行
- ora - 实行loading效果

让我们来把这些库全部安装一遍

## commander

根据[commander文档](https://github.com/tj/commander.js/blob/master/Readme_zh-CN.md#%e5%b8%b8%e7%94%a8%e9%80%89%e9%a1%b9%e7%b1%bb%e5%9e%8bboolean-%e5%9e%8b%e9%80%89%e9%a1%b9%e5%92%8c%e5%b8%a6%e5%8f%82%e6%95%b0%e9%80%89%e9%a1%b9)的一些参数，我们来编写脚本 `ych.js`


```js
#!/usr/bin/env node
const program = require('commander')

// 获取package.json中的版本信息
program.version(require("../package.json").version)

// 解析指令，这点很重要  不解析指令则无效
program.parse(process.argv)
```

commander自带 `-V` 和 `-h` 两个命令，运行 `ych -h`可看到：

```bash
xxx@xxxdeMacBook-Pro y-cli % ych -h
Usage: ych [options]

Options:
  -V, --version  output the version number
  -h, --help     display help for command
```

`.option()` 加入自定义命令

```js
program.option('-d, --description', 'ych 脚手架简介：。。。。')
```

可以发现已经加上该命令：

```bash
xxx@xxxdeMacBook-Pro y-cli % ych -h
Usage: ych [options]

Options:
  -V, --version      output the version number
  -d, --description  ych 脚手架简介：。。。。
  -h, --help         display help for command
```

`.command()` 自定义命令，

基础格式：

```
program.option('hello <param1> [param2]')
```

值得注意的是，尖括号`<>`里的参数是必填参数，方括号`[]`里的参数是可选参数

利用`.command()`写一个简单的demo，弄清整个基础流程：
```js
program
	.command('hello <param1> [param2]')
  // 命令里利用.usage()参数化，供后面的.action()回调使用：
	.usage('<command> <param1> [param2]')
  // 回调处理：
	.action((param1, param2)=>{
		console.log(param1);
		console.log(param2);
	})
```

```bash
ziyouzhiyi@ziyouzhiyideMacBook-Pro y-cli % ych hello
error: missing required argument 'param1'
ziyouzhiyi@ziyouzhiyideMacBook-Pro y-cli % ych hello t 
t
undefined
ziyouzhiyi@ziyouzhiyideMacBook-Pro y-cli % ych hello t y
t
y
```

上面这些参数也可通过`.option()`来实现，但需要加上`-`，如`-react`，如以下的例子，利用参数创建项目：

```js
program.command('create <projectName>')
	.option('-react')
	.option('-vue')
	.action((projectName, option) => {
		const type = Object.keys(option)[0]
		switch(type) {
			case "Vue":
				console.log("创建vue项目")
				break;
			case "React":
				console.log("创建react项目")
				break;
			default:
				console.log("未添加参数，不能下载")
		}
	})
```

执行命令后可以看到打印：

```bash
ziyouzhiyi@ziyouzhiyideMacBook-Pro y-cli % ych create test -react
创建react项目
```

## download-git-repo
下载的步骤把他替换成真的仓库，需要用到 `download-git-repo` 库

把console.log替换成真实的git仓库

```js
...
  case "React":
    download(
			// 此处应加上 #main 分支名称，否则控制台会显示报错
      'direct:git@github.com:ys558/ych-template.git#main',
      projectName,
      { clone: true },
      (err, x) => {
        // 错误回调：
        if (err) console.log(err)
        console.log(`${projectName} 项目创建成功`)
      }
    )
    break;
  default:
    console.log("未添加参数，不能下载")
...
```

## [inquirer](https://github.com/SBoudrias/Inquirer.js)
👆的步骤下载的仓库是在命令行下直接完成的，如果要像vue一样能让用户输入生成的，可以用该库，我们把代码改造一下，实际上就是在 `.action()` 的回调中进行处理

```js
const questions = [
	{
		type: 'input',
		name: 'projectName',
		message: '请输入项目名称',
	},
	{
		type: 'list',
		name: 'frameWork',
		message: '请选择框架',
		default: 'React',
		choices: ['React','Vue']
	},
]

program
	.command('create')
	.action(() => {
		inquirer.prompt(questions)
			.then(({projectName, frameWork}) => {
				switch (frameWork) {
					case 'React':
						download(
							'direct:git@github.com:ys558/ych-template.git',
							projectName,
							{ clone: true },
							(err) => {
								// 错误回调：
								if (err) console.log(err)
								console.log(`${projectName} 项目创建成功`)
							})
						break;
					case 'Vue':
						download(
							'direct:git@github.com:ys558/ych-template.git',
							projectName,
							{ clone: true },
							(err) => {
								// 错误回调：
								if (err) console.log(err)
								console.log(`${projectName} 项目创建成功`)
							})
						break;
					default:
						break;
				}
			})
	})
```

## 美化

### [`chalk`](https://github.com/chalk/chalk)，[`figlet`](https://github.com/patorjk/figlet.js)
美化终端字体，如 `chalk`:

```js
	if (err) {
		console.log(chalk.bgYellow(err))
		return
	}else{
		console.log(`${chalk.bgGrey(projectName)} ${chalk.greenBright('项目创建成功')}`)
	}
```

`figlet`:

```js
figlet.defaults({font: 'Standard'})
function logo(){
	console.log(figlet.textSync('hi ych!'))
}
```

### [`ora`](https://github.com/sindresorhus/ora)
这是一个比较麻烦的模块，他是 `es module` 类型的`import`导入模块，而 node 用的是`commonjs` 的 `require` 导入模块，而且须在 `package.json` 里添加 `{ "type" : "module" }` 才能正常加载，

## [完整代码仓库](https://github.com/ys558/my-node-cli-ych)

