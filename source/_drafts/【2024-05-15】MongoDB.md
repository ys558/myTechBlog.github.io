---
title: MongoDB 自学笔记
date: 2024-05-15 17:00:00
tags:
  - MongoDB
---

最近将以前的笔记和一些常识捋了一遍，并结合最新的 MongoDB 内容，重新写了这篇文章。

<!-- more -->

## 简介

MongoDB 是一个开源的 NoSQL 文档型数据库，它使用 JSON 文档来存储数据，而不是使用 SQL 语句来操作数据。MongoDB 是一个分布式数据库，可以 horizontal scale，可以水平扩展。

业务应用场景
传统的关系型数据库（如 MySQL），在数据操作的“三高“需求以及应对 Web2.0 的网站需求面前，显得力不从心。

- High performance - 对数据库高并发读写的需求。
- Huge Storage-对海量数据的高效率存储和访问的需求。
- High Scalability && High Availability-对数据库的高可扩展性和高可用性的需求。
  而 MongoDB 可应对”三高”需求。

具体的应用场景如：
1）社交场景，使用 MongoDB 存储存储用户信息，以及用户发表的朋友圈信息，通过地理位置索引实现附近的人、地点等功能。
2）游戏场景，使用 MongoDB 存储游戏用户信息，用户的装备、积分等直接以内嵌文档的形式存储，方便查询、高效率存储和访问。
3）物流场景，使用 MongoDB 存储订单信息，订单状态在运送过程中会不断更新，以 MongoDB 内嵌数组的形式来存储，一次查询就能将订单所有的变更读取出来。
4）物联网场景，使用 MongoDB 存储所有接入的智能设备信息，以及设备汇报的日志信息，并对这些信息进行多维度的分析。
5）视频直播，使用 MongoDB 存储用户信息、点赞互动信息等。

2024 年，MongoDB 官方，宣布：

> MongoDB 很荣幸被评为 2023 年 Gartner® 云数据库管理系统（CDBMS）魔力象限领导者。我们相信，这使得 MongoDB 成为唯一连续两年被评为领导者的专用应用程序数据库提供商。

MongoDB 现在是云数据库的领导者，在 B 端领域，尤其是工业及企业互联网，MongoDB 已经成为非常流行的数据库。

## 安装：

## Mac

参考这篇[官方安装文档](https://www.mongodb.com/docs/manual/tutorial/install-mongodb-on-os-x/)

由于是拿来自己用的，所以建议 Mac 的安装包用 `Homebrew` 来管理即可。

先安装 `Homebrew`， `Homebrew`会自动创建本地的 mongo 存储目录及 log 目录。并设置源为国内源，他是 Mac 的默认包管理工具。

安装成功后，会看到 `mongod` 的版本信息：

```bash
(base) zyzy:~ $ mongod --version
db version v7.0.8
Build Info: {
    "version": "7.0.8",
    "gitVersion": "c5d33e55ba38d98e2f48765ec4e55338d67a4a64",
    "modules": [],
    "allocator": "system",
    "environment": {
        "distarch": "aarch64",
        "target_arch": "aarch64"
    }
}
```

根据上面 mongo 的安装的文档，我还碰到一个比较奇葩的问题，在运行 `brew services start mongodb-community@7.0` 时，会报错如下：

```bash
(base) zyzy:~ $ brew services start mongodb-community@7.0
Error: Your Homebrew is too outdated for `brew services`. Please run `brew update`!
(base) zyzy:~ $ brew update
HOMEBREW_BREW_GIT_REMOTE set: using https://mirrors.aliyun.com/homebrew/brew.git as the Homebrew/brew Git remote.
Already up-to-date.
```

我在 stack overflow 上找到了些方法：https://stackoverflow.com/questions/64821648/homebrew-fails-on-macos-big-sur ，但试过之后还是无解。

既然不能用 Homebrew 跑服务，那么就执行另一个命令在运行，根据官网建议，Mongo DB 在 Mac 后台运行，需跑：

```bash
mongod --config /opt/homebrew/etc/mongod.conf --fork
```

### Mongo Compass

Mongo 官方的 GUI 界面，在[这里](https://www.mongodb.com/try/download/compass)下载

## 表结构

Mongo 和普通 SQL 数据库的区别：

| 术语   | SQL                 | MongoDB                    |
| ------ | ------------------- | -------------------------- |
| 数据库 | 数据库              | 集合(collection)           |
| 表     | 表格(table)         | 集合(collection)           |
| 行     | 行(row)             | 文档(document)             |
| 列     | 列(column)          | 字段(field)                |
| 索引   | 索引(index)         | 索引(index)                |
| 表连接 | 表连接(table joins) | 嵌入式文档(json 嵌套格式)  |
| 主键   | 主键(primary key)   | 自动生成的唯一标识符(\_id) |

## 可存储数据类型

| 数据类型      | 描述                                                                                                                            | 举例                    |
| ------------- | ------------------------------------------------------------------------------------------------------------------------------- | ----------------------- |
| 字符串        | UTF-8 字符串都可表示为字符串类型的数据                                                                                          | {"x":"foobar"}          |
| 对象 id       | 对象 id 是文档的 12 字节的唯一 ID                                                                                               | {"X":ObjectId()}        |
| 布尔值        | 真或者假：true 或者 false                                                                                                       | {"x":true}              |
| 数组          | 值的集合或者列表可以表示成数组                                                                                                  | {"x":["a","b","c"]}     |
| 类型不可用    | JavaScript 仅支持 64 位浮点数，所以 shell 是不支持该类型的，shell 中默认会转换成 32 位整数，32 位整数会被自动转换成 64 位浮点数 |                         |
| 64 位整数     | shell 中使用一个特殊的内嵌文档来显示 64 位整数                                                                                  |                         |
| 64 位浮点     | shell 中的数字就是这一种类型                                                                                                    | {"x":3.14159,"y":3}     |
| null          | 表示空值或者未定义的对象                                                                                                        | {"x":null}              |
| undefined     | 文档中也可以使用未定义类型                                                                                                      | {"x":undefined}         |
| 符号          | shell 会将数据库中的符号类型的数据自动转换成字符串                                                                              |                         |
| 正则表达式    | 文档中可以包含正则表达式，采用 JavaScript 的正则表达式语法                                                                      | {"x":/foobar/i}         |
| 代码          | 文档中还可以包含 JavaScript 代码                                                                                                | {"x":function(/_..._/)} |
| 二进制数      | 二进制数据可以由任意字节的串组成，不过 shell 中无法使用                                                                         |                         |
| 最大值/最小值 | BSON 包括一个特殊类型，表示可能的最大值和最小值                                                                                 |                         |

## collections

在命令行输入 `show dbs` 或 `show databases`:

```bash
> show dbs
admin   40.00 KiB
config  72.00 KiB
local   40.00 KiB
```

- `admin`：从权限的角度来看，这是"root"数据库。要是将一个用户添加到这个数据库，这个用户自动继承所有数据库的权限。一些特定的服务器端命令也只能从这个数据库运行，比如列出所有的数据库或者关闭服务器。1 I
- `local`： 集群模式下，该数据永远不会被复制，可以用来存储限于本地单台服务器的任意集合。
- `config`：当 Mongo 用于分片设置时，config 数据库在内部使用，用于保存分片的相关信息。

### 基操

#### 数据库操作

```bash
show dbs
use articledb
db.createCollection("my")
```

操作示例：

```bash
test> show dbs
admin       40.00 KiB
config     108.00 KiB
local       40.00 KiB
test> use articledb
# 创建数据库，此时数据库还在内存里，没写到硬盘里：
test> show dbs
admin       40.00 KiB
config     108.00 KiB
local       40.00 KiB
# 必须创建集合createCollection，才能show bds看到改数据库
test> db.createCollection("my")
{ ok: 1 }
switched to db articledb
articledb> show collections
my
# 创建完collection之后，数据库才会写到硬盘里：
test> show dbs
admin       40.00 KiB
articledb    8.00 KiB
config     108.00 KiB
local       40.00 KiB
```

#### 其他数据库和表操作

```bash
# 删除数据库：
db.collection.dropDatabase()

# 删除表：
db.collection.drop()
```

## 案例需求

生成以下表格：

| 字段名称       | 字段含义       | 字段类型           | 备注                        |
| -------------- | -------------- | ------------------ | --------------------------- |
| \_id           | ID             | Objectld 或 String | Mongo 的主键的字段          |
| articleid      | 文章 ID        | String             |                             |
| content        | 评论内容       | String             |                             |
| userid         | 评论人 ID      | String             |                             |
| nickname       | 评论人昵称     | String             |                             |
| createdatetime | 评论的日期时间 | Date               |                             |
| likenum        | 点赞数         | Int32              |                             |
| replynum       | 回复数         | Int32              |                             |
| state          | 状态           | String             | 0：不可见；1：可见；        |
| parentid       | 上级 ID        | String             | 如果为 0 表示文章的顶级评论 |

1. 创建数据库

1. 创建集合
1. 插入数据
