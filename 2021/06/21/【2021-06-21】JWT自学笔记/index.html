<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>JWT自学笔记 | 自由の翼小栈</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="JWT是一种跨域鉴权技术，现广泛运用于各大网站，本文结合demo代码简单阐述，本篇的概念部分1到4点搬运了阮大神的这篇文章，第5点结合我自己写的一个Demo来实现具体的JWT业务">
<meta property="og:type" content="article">
<meta property="og:title" content="JWT自学笔记">
<meta property="og:url" content="https://zyzy.info/2021/06/21/%E3%80%902021-06-21%E3%80%91JWT%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="自由の翼小栈">
<meta property="og:description" content="JWT是一种跨域鉴权技术，现广泛运用于各大网站，本文结合demo代码简单阐述，本篇的概念部分1到4点搬运了阮大神的这篇文章，第5点结合我自己写的一个Demo来实现具体的JWT业务">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ys558/my-blog-imgs@0.40/articles/jwt%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/cover.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ys558/my-blog-imgs@0.40/articles/jwt%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/00.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ys558/my-blog-imgs@0.40/articles/jwt%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/01.gif">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ys558/my-blog-imgs@0.40/articles/jwt%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/05.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ys558/my-blog-imgs@0.40/articles/jwt%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/02.gif">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ys558/my-blog-imgs@0.40/articles/jwt%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/03.gif">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/ys558/my-blog-imgs@0.40/articles/jwt%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/06.gif">
<meta property="article:published_time" content="2021-06-21T08:37:49.000Z">
<meta property="article:modified_time" content="2022-03-27T04:40:51.524Z">
<meta property="article:author" content="自由の翼">
<meta property="article:tag" content="JWT">
<meta property="article:tag" content="Token">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/ys558/my-blog-imgs@0.40/articles/jwt%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/cover.jpg">
  
    <link rel="alternate" href="/atom.xml" title="自由の翼小栈" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">自由の翼小栈</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">技术&amp;生活分享</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS 订阅"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://zyzy.info"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-【2021-06-21】JWT自学笔记" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/06/21/%E3%80%902021-06-21%E3%80%91JWT%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/" class="article-date">
  <time class="dt-published" datetime="2021-06-21T08:37:49.000Z" itemprop="datePublished">2021-06-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      JWT自学笔记
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><img src="https://cdn.jsdelivr.net/gh/ys558/my-blog-imgs@0.40/articles/jwt%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/cover.jpg"></p>
<p>JWT是一种跨域鉴权技术，现广泛运用于各大网站，本文结合<a href="">demo</a>代码简单阐述，本篇的概念部分1到4点搬运了阮大神的这篇<a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html">文章</a>，第5点结合我自己写的一个Demo来实现具体的JWT业务</p>
<span id="more"></span>

<h2 id="1-JWT是什么？"><a href="#1-JWT是什么？" class="headerlink" title="1. JWT是什么？"></a>1. JWT是什么？</h2><p><a target="_blank" rel="noopener" href="https://jwt.io/">JSON Web Token (jwt)</a>是一个开放标准(RFC 7519)，它定义了一种紧凑的、自包含的方式，用于作为JSON对象在各方之间安全地传输信息。该信息可以被验证和信任，因为它是数字签名的。</p>
<p>简单来说就是用于跨域鉴权。一般来说我们鉴权的过程如下：</p>
<blockquote>
<p>1、用户向服务器发送用户名和密码。<br>2、服务器验证通过后，在当前对话（session）里面保存相关数据，比如用户角色、登录时间等等。<br>3、服务器向用户返回一个 session_id，写入用户的 Cookie。<br>4、用户随后的每一次请求，都会通过 Cookie，将 session_id 传回服务器。<br>5、服务器收到 session_id，找到前期保存的数据，由此得知用户的身份。   </p>
</blockquote>
<p>上述过程如果单机当然没有问题，如果是集群，或跨域的服务导向架构，就要求 session 数据共享，每台服务器都能够读取 session。<br>举例来说，A 网站和 B 网站是同一家公司的关联服务。现在要求，用户只要在其中一个网站登录，再访问另一个网站就会自动登录，请问怎么实现？<br>一种解决方案是 session 数据持久化，写入数据库或别的持久层。各种服务收到请求后，都向持久层请求数据。这种方案的优点是架构清晰，缺点是工程量比较大。另外，持久层万一挂了，就会单点失败。</p>
<p>另一种方案是服务器索性不保存 session 数据了，所有数据都保存在客户端，每次请求都发回服务器。 jwt 就是这种方案的一个代表。</p>
<h2 id="2-JWT的结构"><a href="#2-JWT的结构" class="headerlink" title="2. JWT的结构"></a>2. JWT的结构</h2><p>我们可以在<a target="_blank" rel="noopener" href="https://jwt.io/">官网</a>看到他的结构</p>
<p><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/ys558/my-blog-imgs@0.40/articles/JWT%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/00.png">JWT结构</a></p>
<p>可以看到分为以下3部分：</p>
<blockquote>
<p>Header（头部）<br>Payload（负载）<br>Signature（签名）   </p>
</blockquote>
<h3 id="Header-头部"><a href="#Header-头部" class="headerlink" title="Header 头部"></a>Header 头部</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;alg&quot;</span>: <span class="string">&quot;PS384&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;typ&quot;</span>: <span class="string">&quot;JWT&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上分别代表</p>
<ul>
<li><code>&quot;typ&quot;</code> 表示这个令牌（token）的类型（type）</li>
<li><code>&quot;alg&quot;</code> 表示该token的算法类型，默认为HMAC SHA256（写成 HS256） </li>
</ul>
<h3 id="Payload-负载"><a href="#Payload-负载" class="headerlink" title="Payload 负载"></a>Payload 负载</h3><p>以下为官方规定的可选字段：</p>
<blockquote>
<p>iss (issuer)：签发人<br>exp (expiration time)：过期时间<br>sub (subject)：主题<br>aud (audience)：受众<br>nbf (Not Before)：生效时间<br>iat (Issued At)：签发时间<br>jti (JWT ID)：编号   </p>
</blockquote>
<p>注意，这部分是不加密的，是简单的Base64转码过程，所以密文信息不能放在这部分，除非你的文字本身加密过</p>
<h3 id="Signature-签名"><a href="#Signature-签名" class="headerlink" title="Signature 签名"></a>Signature 签名</h3><p>这部分是对前两部分的签名，防止数据篡改。</p>
<p>需指定一个密钥（secret）。这个密钥只有服务器才知道，不能泄露给用户。然后，使用 Header 里面指定的签名算法（默认是 HMAC SHA256），按照下面的公式产生签名。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HMACSHA256(base64UrlEncode(header) + <span class="string">&quot;.&quot;</span> + base64UrlEncode(payload), secret)</span><br></pre></td></tr></table></figure>

<p>算出签名以后，把 Header、Payload、Signature 三个部分拼成一个字符串，每个部分之间用”点”（.）分隔，就可以返回给用户。</p>
<p>Header 和 Payload 串型化的算法是 Base64URL。这个算法跟 Base64 算法基本类似，但有一些小的不同。</p>
<p>JWT 作为一个令牌（token），有些场合可能会放到 URL（比如 api.example.com/?token=xxx）。Base64 有三个字符<code>+</code>、<code>/</code>和<code>=</code>，在 URL 里面有特殊含义，所以要被替换掉：<code>=</code>被省略、<code>+</code>替换成<code>-</code>，<code>/</code>替换成<code>_</code> 。这就是 Base64URL 算法。</p>
<h2 id="3-JWT使用方法："><a href="#3-JWT使用方法：" class="headerlink" title="3. JWT使用方法："></a>3. JWT使用方法：</h2><p>客户端收到服务器返回的 JWT，可以储存在 Cookie 里面，也可以储存在 localStorage。</p>
<p>此后，客户端每次与服务器通信，都要带上这个 JWT。你可以把它放在 Cookie 里面自动发送，但是这样不能跨域，所以更好的做法是放在 HTTP 请求的头信息Authorization字段里面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Bearer &lt;token&gt;</span><br></pre></td></tr></table></figure>

<p>另一种做法是，跨域的时候，JWT 就放在 POST 请求的数据体里面。</p>
<h2 id="4-使用时几个注意点"><a href="#4-使用时几个注意点" class="headerlink" title="4. 使用时几个注意点"></a>4. 使用时几个注意点</h2><p>（1）JWT <font color=#FF0000>默认是不加密</font>，但也是可以加密的。生成原始 Token 以后，可以用密钥再加密一次。</p>
<p>（2）JWT 不加密的情况下，不能将秘密数据写入 JWT。</p>
<p>（3）JWT 不仅可以用于认证，也可以用于交换信息。有效使用 JWT，可以降低服务器查询数据库的次数。</p>
<p>（4）JWT 的最大<font color=#FF0000>缺点</font>是，由于服务器不保存 session 状态，因此<font color=#FF0000>无法在使用过程中废止</font>某个 token，或者更改 token 的权限。也就是说，一旦 JWT 签发了，在到期之前就会始终有效，除非服务器部署额外的逻辑。</p>
<p>（5）JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为减少盗用，<font color=#FF0000>JWT 的有效期应该设置得比较短</font>。对于一些比较重要的权限，使用时应该再次对用户进行认证。</p>
<p>（6）为了减少盗用，<font color=#FF0000>JWT </font>不应该使用 HTTP 协议明码传输，<font color=#FF0000>要使用 HTTPS 协议传输。</font></p>
<h2 id="5-Demo-代码-及实际使用场景"><a href="#5-Demo-代码-及实际使用场景" class="headerlink" title="5. Demo 代码 及实际使用场景"></a>5. <a target="_blank" rel="noopener" href="https://github.com/ys558/jwt-learn">Demo 代码</a> 及实际使用场景</h2><p>完整代码可点击标题可见git仓库，下面按照我编写代码的顺序阐述几个注意点，</p>
<h3 id="代码里一些配置的解析"><a href="#代码里一些配置的解析" class="headerlink" title="代码里一些配置的解析"></a>代码里一些配置的解析</h3><ol>
<li><code>.env</code> 文件中的两个token生成可以按照以下办法，利用node REPL的<code>crypto</code>模块生成：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yuyi@home-pc MINGW64 /e/study/code/2021/jwt-learn (master)</span><br><span class="line">$ node</span><br><span class="line">Welcome to Node.js v14.14.0.      </span><br><span class="line">Type <span class="string">&quot;.help&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt; require(<span class="string">&#x27;crypto&#x27;</span>).randomBytes(64).toString(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;6dedc49577ebb7c685246241533dc068ee43cba49d01b34d243b6b8924786a69d6637c4335e508343ba4c27a1fec1d2f11ea5eea173bd4af04c0f263a4ee98b5&#x27;</span></span><br><span class="line">&gt; require(<span class="string">&#x27;crypto&#x27;</span>).randomBytes(64).toString(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;4f3ea9c60d55b2a8a58f559ae76e133353a973708d6575daa10ac4bd28f6314d261a4458703be1333f65eddb29a1b58e21ebe493fede5c198952863f1f97e023&#x27;</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>发送请求检测时不需要安装postman，只需在 vs code 上安装神器 <code>REST Client</code> ，不仅可以测普通的接口，最新的 <code>GraphQL</code> 语法也支持，其测试文件以 rest 结尾，如 <code>request.rest</code></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/dotenv">dotenv</a> 是个不需要依赖就能读取项目中 <code>.env</code> 文件的配制的库，只需在 文件开始引用即可，如： </p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dotenv库引用：</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;dotenv&#x27;</span>).config()</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 登录token鉴权</span></span><br><span class="line">  <span class="keyword">const</span> username = req.body.username</span><br><span class="line">  <span class="keyword">const</span> user = &#123; <span class="attr">name</span>: username &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> accessToken = jwt.sign(user, process.env.ACCESS_TOKEN_SECRET)</span><br><span class="line">  res.json(&#123; accessToken &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="解析及测试主代码"><a href="#解析及测试主代码" class="headerlink" title="解析及测试主代码"></a>解析及测试主代码</h3><ol>
<li><code>npm run dev-start</code> 把服务跑起后，点击 <code>request.rest</code> 文件的这里下面的位置，这些最基础的功能在 <code>01_base</code> 分支的<a target="_blank" rel="noopener" href="https://github.com/ys558/jwt-learn/tree/base">这些代码</a>就能实现，测试接口返回的正确与否</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/ys558/my-blog-imgs@0.40/articles/jwt%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/00.png" alt="rest cliennt测试接口"></p>
<ol start="2">
<li>鉴权部分抽离为单独的中间件函数，<code>02_authenticate_token_modulize</code> 分支的<a target="_blank" rel="noopener" href="https://github.com/ys558/jwt-learn/tree/02_authenticate_token_modulize">这些代码</a>，</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">authenticateToken</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> authHeader = req.headers[<span class="string">&#x27;authorization&#x27;</span>]</span><br><span class="line">  <span class="keyword">const</span> token = authHeader &amp;&amp; authHeader.split(<span class="string">&#x27; &#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">  <span class="keyword">if</span> (token == <span class="literal">null</span>) <span class="keyword">return</span> res.sendStatus(<span class="number">401</span>)</span><br><span class="line">  jwt.verify(token, process.env.ACCESS_TOKEN_SECRET, <span class="function">(<span class="params">err, user</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> res.sendStatus(<span class="number">403</span>)</span><br><span class="line">    req.user = user</span><br><span class="line">    <span class="comment">// 交给下个中间件：</span></span><br><span class="line">    next()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将其放入<code>app.get(&#39;/posts&#39;)</code>的第二个参数即可调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// authenticateToken 为鉴权中间件：</span></span><br><span class="line">app.get(<span class="string">&#x27;/posts&#x27;</span>, authenticateToken, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;   </span><br><span class="line">  res.json(posts.filter(<span class="function"><span class="params">post</span> =&gt;</span> post.username === req.user.name))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/ys558/my-blog-imgs@0.40/articles/jwt%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/01.gif" alt="加入 authenticateToken middleware 后的自测"></p>
<ol start="3">
<li>将鉴权部分，即token的分发，拆分为单独一个模块。集中管理各个路由，包括<code>/login</code>, <code>/logout</code>的token，在后端属于微服务的架构</li>
</ol>
<p>单独把颁发token这部分内容封装一个单独文件，新建文件 <code>authServer.js</code> 及更新命令 <code>auth</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">  &quot;auth-start&quot;: &quot;nodemon authServer.js&quot;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><a target="_blank" rel="noopener" href="https://github.com/ys558/jwt-learn/tree/03_refresh_token">Refresh Token</a></li>
</ol>
<p>上面是正常流程的注册登录所用的token，但实际业务中，<code>Access Token</code> 设置的时间不可能很长，比如说10分钟，而10分钟对于用户体验来说肯定不好，一过期的话就要重新登录，所以大多数业务采用了另一种折中的方案，即多生成一个 <code>Refresh Token</code>，这种的过期时间比较长，例如7天免登录</p>
<ul>
<li>如果携带 <code>Access Token</code> 访问需要认证的接口时鉴权失败（例如返回 401 错误），则客户端使用 <code>Refresh Token</code> 向刷新接口申请新的 <code>Access Token</code>   </li>
<li>如果 <code>Refresh Token</code> 没有过期，服务端向客户端下发新的 <code>Access Token</code>   </li>
<li>客户端使用新的 <code>Access Token</code> 访问需要重新认证的接口</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/ys558/my-blog-imgs@0.40/articles/jwt%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/05.jpg" alt="Refresh Token工作流程"></p>
<p>下面解析 <code>Refresh Token</code> 的制作过程：<br><code>authServer.js</code>文件中把生成Token封装成一个函数，并在 <code>app.post(&#39;/login&#39;, (req,res) =&gt; &#123;</code> 里应用 </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> username = req.body.username</span><br><span class="line">  <span class="keyword">const</span> user = &#123; <span class="attr">name</span>: username &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> accessToken = generateAccessToken(user)</span><br><span class="line">  <span class="keyword">const</span> refreshToken = jwt.sign(user, process.env.REFRESH_TOKEN_SECRET)</span><br><span class="line">  refreshTokens.push(refreshToken)</span><br><span class="line">  res.json(&#123; <span class="attr">accessToken</span>: accessToken, <span class="attr">refreshToken</span>: refreshToken &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateAccessToken</span>(<span class="params">user</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> jwt.sign(user, process.env.ACCESS_TOKEN_SECRET, &#123; <span class="attr">expiresIn</span>: <span class="string">&#x27;15s&#x27;</span> &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次测试，能看到 Refresh Token 的返回结果，但我们发现直接用<code>/posts</code> 接口请求，会出现 Forbidden 报错：<br><img src="https://cdn.jsdelivr.net/gh/ys558/my-blog-imgs@0.40/articles/jwt%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/02.gif" alt="测试能否返回 Refresh Token"></p>
<p>此时，我们再写多个函数控制 token 更新：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里的 refreshTokens</span></span><br><span class="line"><span class="keyword">let</span> refreshTokens = []</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/token&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> refreshToken = req.body.token</span><br><span class="line">  <span class="keyword">if</span> (refreshToken == <span class="literal">null</span>) <span class="keyword">return</span> res.sendStatus(<span class="number">401</span>)</span><br><span class="line">  <span class="keyword">if</span> (!refreshTokens.includes(refreshToken)) <span class="keyword">return</span> res.sendStatus(<span class="number">403</span>)</span><br><span class="line">  jwt.verify(refreshToken, process.env.REFRESH_TOKEN_SECRET, <span class="function">(<span class="params">err, user</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> res.sendStatus(<span class="number">403</span>)</span><br><span class="line">    <span class="keyword">const</span> accessToken = generateAccessToken(&#123; <span class="attr">name</span>: user.name &#125;)</span><br><span class="line">    res.json(&#123; accessToken &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>request.rest</code> 文件添加一个 <code>/token</code> 进行测试，body的 <code>&quot;token&quot;</code> 暂且留空</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">###</span><br><span class="line">POST http:&#x2F;&#x2F;localhost:3001&#x2F;token</span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;token&quot;: &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进行以下操作，可以看到效果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/ys558/my-blog-imgs@0.40/articles/jwt%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/03.gif" alt="Refresh Token效果"></p>
<p>但上述的 <code>GET</code> <code>/posts</code> 操作，因 <code>function generateAccessToken(user)&#123;</code> 函数里过期时间只设置了 15秒，所以15秒后，需要 <code>POST</code> <code>/token</code> 重新获得一个 <code>refresh token</code> 才能继续维持登录状态</p>
<ol start="5">
<li>登出模块</li>
</ol>
<p>完整代码在<a target="_blank" rel="noopener" href="https://github.com/ys558/jwt-learn/tree/04_logout">这里</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.delete(<span class="string">&#x27;/logout&#x27;</span>, <span class="function">(<span class="params">req, res</span>)=&gt;</span>&#123;</span><br><span class="line">  refreshTokens = refreshTokens.filter( <span class="function"><span class="params">token</span> =&gt;</span> token !== req.body.token)</span><br><span class="line">  res.sendStatus(<span class="number">204</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>用 <code>delete</code> 方法，删除 <code>let refreshTokens = []</code> 里原本存在的 <code>refresh token</code>，再次请求 <code>/posts</code> 时，会发现已经变为 <code>Forbidden</code> 状态</p>
<p><img src="https://cdn.jsdelivr.net/gh/ys558/my-blog-imgs@0.40/articles/jwt%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/06.gif" alt="测试能否返回 Refresh Token"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://zyzy.info/2021/06/21/%E3%80%902021-06-21%E3%80%91JWT%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0/" data-id="cl18sv6zz0014k88oca6v9zuv" data-title="JWT自学笔记" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JWT/" rel="tag">JWT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Token/" rel="tag">Token</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/07/07/%E3%80%902021-07-07%E3%80%91%E5%8F%91%E5%B8%83%E8%87%AA%E5%B7%B1%E7%9A%84npm-package%E6%B5%81%E7%A8%8B/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          发布自己的npm-package流程
        
      </div>
    </a>
  
  
    <a href="/2021/06/19/%E3%80%902021-06-19%E3%80%91RenderProps%E5%92%8C%E9%AB%98%E9%98%B6%E7%BB%84%E4%BB%B6%E7%9A%84%E5%8F%8D%E5%90%91%E7%BB%A7%E6%89%BF/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">RenderProps和高阶组件的反向继承</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Babel/" rel="tag">Babel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CDN/" rel="tag">CDN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CJS/" rel="tag">CJS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dart/" rel="tag">Dart</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES/" rel="tag">ES</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/" rel="tag">ES6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ESM/" rel="tag">ESM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Electron/" rel="tag">Electron</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flutter/" rel="tag">Flutter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Github-Page/" rel="tag">Github Page</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GraphQL/" rel="tag">GraphQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HOC/" rel="tag">HOC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IntersectionObserver/" rel="tag">IntersectionObserver</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JWT/" rel="tag">JWT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nodejs/" rel="tag">Nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React-Hooks/" rel="tag">React Hooks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React-Query/" rel="tag">React Query</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swagger-UI/" rel="tag">Swagger UI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Token/" rel="tag">Token</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Type-Script/" rel="tag">Type Script</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/" rel="tag">Vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webpack/" rel="tag">Webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" rel="tag">Web性能优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/conventional-commit/" rel="tag">conventional commit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/esbuild/" rel="tag">esbuild</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eventEmitter/" rel="tag">eventEmitter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flutter/" rel="tag">flutter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lerna/" rel="tag">lerna</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mono-repo/" rel="tag">mono repo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/" rel="tag">node</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node-cli/" rel="tag">node cli</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/npm-package/" rel="tag">npm package</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/" rel="tag">react</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssr/" rel="tag">ssr</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swagger-jsdoc/" rel="tag">swagger-jsdoc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/type-script/" rel="tag">type script</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/" rel="tag">webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yarn/" rel="tag">yarn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" rel="tag">反向代理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag">后端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B7%A8%E7%AB%AF/" rel="tag">跨端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Babel/" style="font-size: 13.33px;">Babel</a> <a href="/tags/CDN/" style="font-size: 10px;">CDN</a> <a href="/tags/CJS/" style="font-size: 10px;">CJS</a> <a href="/tags/Dart/" style="font-size: 13.33px;">Dart</a> <a href="/tags/ES/" style="font-size: 13.33px;">ES</a> <a href="/tags/ES6/" style="font-size: 10px;">ES6</a> <a href="/tags/ESM/" style="font-size: 10px;">ESM</a> <a href="/tags/Electron/" style="font-size: 10px;">Electron</a> <a href="/tags/Flutter/" style="font-size: 10px;">Flutter</a> <a href="/tags/Github-Page/" style="font-size: 10px;">Github Page</a> <a href="/tags/GraphQL/" style="font-size: 10px;">GraphQL</a> <a href="/tags/HOC/" style="font-size: 10px;">HOC</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/IntersectionObserver/" style="font-size: 10px;">IntersectionObserver</a> <a href="/tags/JWT/" style="font-size: 10px;">JWT</a> <a href="/tags/Nginx/" style="font-size: 10px;">Nginx</a> <a href="/tags/Nodejs/" style="font-size: 10px;">Nodejs</a> <a href="/tags/React/" style="font-size: 20px;">React</a> <a href="/tags/React-Hooks/" style="font-size: 10px;">React Hooks</a> <a href="/tags/React-Query/" style="font-size: 10px;">React Query</a> <a href="/tags/Swagger-UI/" style="font-size: 10px;">Swagger UI</a> <a href="/tags/Token/" style="font-size: 10px;">Token</a> <a href="/tags/Type-Script/" style="font-size: 10px;">Type Script</a> <a href="/tags/Vue/" style="font-size: 13.33px;">Vue</a> <a href="/tags/Webpack/" style="font-size: 16.67px;">Webpack</a> <a href="/tags/Web%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 10px;">Web性能优化</a> <a href="/tags/conventional-commit/" style="font-size: 10px;">conventional commit</a> <a href="/tags/esbuild/" style="font-size: 13.33px;">esbuild</a> <a href="/tags/eventEmitter/" style="font-size: 10px;">eventEmitter</a> <a href="/tags/flutter/" style="font-size: 10px;">flutter</a> <a href="/tags/lerna/" style="font-size: 10px;">lerna</a> <a href="/tags/mono-repo/" style="font-size: 10px;">mono repo</a> <a href="/tags/node/" style="font-size: 10px;">node</a> <a href="/tags/node-cli/" style="font-size: 10px;">node cli</a> <a href="/tags/npm-package/" style="font-size: 10px;">npm package</a> <a href="/tags/react/" style="font-size: 13.33px;">react</a> <a href="/tags/ssr/" style="font-size: 10px;">ssr</a> <a href="/tags/swagger-jsdoc/" style="font-size: 10px;">swagger-jsdoc</a> <a href="/tags/type-script/" style="font-size: 10px;">type script</a> <a href="/tags/webpack/" style="font-size: 13.33px;">webpack</a> <a href="/tags/yarn/" style="font-size: 10px;">yarn</a> <a href="/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" style="font-size: 10px;">反向代理</a> <a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 13.33px;">后端</a> <a href="/tags/%E8%B7%A8%E7%AB%AF/" style="font-size: 10px;">跨端</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 10px;">面试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/03/20/%E3%80%902022-03-20%E3%80%91%E7%94%A8esbuild%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84js%E7%B1%BB%E5%BA%93npm%E5%8C%85(%E6%9B%B4%E6%96%B0%E4%B8%AD,%E6%9C%AA%E5%AE%8C)/">用esbuild创建自己的js类库npm包(更新中,未完)</a>
          </li>
        
          <li>
            <a href="/2021/11/09/%E3%80%902021-11-09%E3%80%91MonoRepo%E7%AE%80%E4%BB%8B%E5%8F%8A%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95%20copy/">Mono Repo 简介及实现方法</a>
          </li>
        
          <li>
            <a href="/2021/10/28/%E3%80%902021-10-28%E3%80%91%E7%94%A8esbuil%E5%88%9B%E5%BB%BAReact%E9%A1%B9%E7%9B%AE/">esbuil用于create-react-app项目的热更新开发</a>
          </li>
        
          <li>
            <a href="/2021/10/26/%E3%80%902021-05-30%E3%80%91Web%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/">Web性能优化（最后更新时间：2021-10-26）</a>
          </li>
        
          <li>
            <a href="/2021/10/17/%E3%80%902021-10-17%E3%80%91%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84node-cli/">创建自己的node cli</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 自由の翼<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>